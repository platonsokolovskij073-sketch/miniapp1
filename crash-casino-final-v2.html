<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Crash Casino</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e1a;
            overflow: hidden;
            color: #fff;
        }

        .container {
            display: flex;
            width: 100vw;
            height: 100vh;
            gap: 15px;
            padding: 15px;
        }

        /* ЛЕВАЯ ПАНЕЛЬ */
        .left-panel {
            width: 380px;
            background: linear-gradient(145deg, #121829 0%, #1a1f35 100%);
            border-radius: 20px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .balance-display {
            background: rgba(255, 215, 0, 0.1);
            padding: 15px 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .balance-label {
            font-size: 13px;
            color: #888;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 28px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-label {
            font-size: 13px;
            color: #888;
            font-weight: 500;
        }

        .input-field {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            padding: 14px 18px;
            font-size: 18px;
            color: #fff;
            transition: all 0.3s;
            width: 100%;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
        }

        /* Убираем стрелочки у number input */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        .auto-stop-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-knob {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch.active .toggle-knob {
            left: 27px;
        }

        .play-button {
            padding: 18px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            margin-top: 10px;
        }

        .play-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
        }

        .play-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .cashout-button {
            padding: 18px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            background: linear-gradient(135deg, #ffd700 0%, #ffb700 100%);
            color: #000;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }

        .cashout-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255, 215, 0, 0.6);
        }

        .cashout-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        /* ПРАВАЯ ПАНЕЛЬ - ИГРА */
        .right-panel {
            flex: 1;
            position: relative;
            background: linear-gradient(145deg, #0f1419 0%, #1a1f2e 100%);
            border-radius: 20px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .multiplier-display {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 15; /* Повышаем z-index */
            font-size: 72px;
            font-weight: 900;
            background: linear-gradient(45deg, #ffd700, #ffca28, #ffe082, #fff9c4);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: goldFlow 4s ease infinite;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }

        @keyframes goldFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .multiplier-display.crashed {
            animation: crashFlash 0.5s;
            background: linear-gradient(45deg, #ff4444, #ff0000);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            background-clip: text;
        }

        @keyframes crashFlash {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.15); }
        }

        /* ТАЙМЕР */
        .timer-display {
            position: absolute;
            top: 30px;
            left: 30px; /* Было right: 40px, теперь слева */
            z-index: 10;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px 25px;
            border-radius: 12px;
            border: 2px solid rgba(102, 126, 234, 0.4);
            backdrop-filter: blur(10px);
        }

        .timer-label {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-bottom: 5px;
        }

        .timer-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            font-family: 'Courier New', monospace;
        }

        .timer-value.betting {
            color: #ffd700;
        }

        /* ТАБЛИЦА СТАВОК */
        .bets-table {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 350px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .bets-table::-webkit-scrollbar {
            width: 4px;
        }

        .bets-table::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .bets-table::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 10px;
        }

        .bet-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            margin-bottom: 4px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 13px;
        }

        .bet-row:hover {
            background: rgba(102, 126, 234, 0.15);
        }

        .bet-player {
            font-weight: bold;
            color: #fff;
            flex: 1;
            font-size: 12px;
        }

        .bet-amount {
            color: #ffd700;
            font-weight: bold;
            margin: 0 10px;
            font-size: 12px;
        }

        .bet-multiplier {
            color: #888;
            font-size: 12px;
            min-width: 60px;
            text-align: right;
        }

        .bet-multiplier.won {
            color: #00ff88;
        }

        .bet-multiplier.lost {
            color: #ff4444;
        }

        .game-status {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            animation: pulse 2s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ОКНО ТЕКУЩЕГО ВЫИГРЫША - В ЛЕВОЙ ПАНЕЛИ */
        .current-profit {
            background: rgba(0, 255, 136, 0.1);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid rgba(0, 255, 136, 0.3);
            margin-top: 15px;
            display: none;
        }

        .current-profit.show {
            display: block;
        }

        .profit-amount {
            font-size: 32px;
            font-weight: bold;
            color: #00ff88;
            text-align: center;
            text-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        /* ИСТОРИЯ ИКСОВ */
        .crash-history {
            position: absolute;
            bottom: 20px;
            left: 370px; /* Было right: 20px, теперь слева от центра */
            z-index: 5; /* Понижаем z-index чтобы звезда была поверх */
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(8px);
            border-radius: 10px;
            padding: 10px 12px;
            border: 1px solid rgba(102, 126, 234, 0.15);
            max-width: 450px;
        }

        .history-title {
            font-size: 10px;
            color: #888;
            margin-bottom: 6px;
            text-align: center;
        }

        .history-items {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .history-item {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
            transition: all 0.3s;
        }

        .history-item.low {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            border: 1px solid rgba(255, 68, 68, 0.4);
        }

        .history-item.medium {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            border: 1px solid rgba(255, 215, 0, 0.4);
        }

        .history-item.high {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid rgba(0, 255, 136, 0.4);
        }

        .history-item.mega {
            background: rgba(138, 43, 226, 0.3);
            color: #e066ff;
            border: 1px solid rgba(138, 43, 226, 0.5);
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ЛЕВАЯ ПАНЕЛЬ -->
        <div class="left-panel">
            <div class="balance-display">
                <div class="balance-label">Баланс</div>
                <div class="balance-amount" id="balance">∞</div>
            </div>

            <div class="input-group">
                <label class="input-label">Сумма ставки (₽)</label>
                <input type="number" class="input-field" id="betAmount" value="100" min="10">
            </div>

            <div class="auto-stop-toggle">
                <div class="toggle-switch" id="autoStopToggle">
                    <div class="toggle-knob"></div>
                </div>
                <span style="flex: 1;">Авто-стоп</span>
            </div>

            <div class="input-group" id="autoStopInputGroup" style="display: none;">
                <label class="input-label">Стоп на множителе</label>
                <input type="number" class="input-field" id="autoStopValue" value="2.00" min="1.10" step="0.01">
            </div>

            <button class="play-button" id="playBtn">Играть</button>
            <button class="cashout-button" id="cashoutBtn" disabled>Забрать</button>

            <div class="current-profit" id="currentProfit">
                <div class="profit-amount" id="profitAmount">0 ₽</div>
            </div>
        </div>

        <!-- ПРАВАЯ ПАНЕЛЬ - ИГРА -->
        <div class="right-panel">
            <canvas id="gameCanvas"></canvas>
            
            <div class="multiplier-display" id="multiplierDisplay">1.00×</div>
            
            <div class="timer-display" id="timerContainer">
                <div class="timer-label" id="timerLabel">До начала</div>
                <div class="timer-value" id="timerValue">10.0</div>
            </div>

            <div class="game-status" id="gameStatus" style="display: none;"></div>

            <div class="bets-table" id="betsTable"></div>

            <div class="crash-history">
                <div class="history-title">ИСТОРИЯ ИКСОВ</div>
                <div class="history-items" id="historyItems"></div>
            </div>
        </div>
    </div>





    <script>
        // ==================== КОНСТАНТЫ И ГЛОБАЛЬНОЕ СОСТОЯНИЕ ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gamePhase = 'betting'; // betting, flying, crashed
        let timer = 10.0;
        let multiplier = 1.00;
        let crashPoint = 2.0;
        let precalculatedCrashPoint = null; // Рассчитывается при ставке
        
        let playerBet = null;
        let currentBets = [];
        let playerHistory = []; // История игр игрока
        let crashHistory = []; // История краш-множителей
        
        let starX, starY, startX, startY;
        let starRotation = 0;
        let trail = [];
        let particles = [];
        let stars = [];
        let planets = [];
        let moonAngle = 0;
        let time = 0;

        const NAMES = ['Алекс', 'Дима', 'Макс', 'Иван', 'Петр', 'Антон', 'Саша', 'Влад', 'Игорь', 'Миша'];

        // ==================== УМНАЯ ЛОГИКА МНОЖИТЕЛЕЙ ====================
        function calculateCrashPoint() {
            const totalBetsAmount = currentBets.reduce((sum, bet) => sum + bet.amount, 0);
            const playerBetAmount = playerBet ? playerBet.amount : 0;
            
            // КРИТИЧЕСКАЯ ЛОГИКА: Если выиграл 300+ в последней игре - ЖЕСТКИЙ СЛИВ
            const lastGame = playerHistory.length > 0 ? playerHistory[playerHistory.length - 1] : null;
            if (lastGame && lastGame.won && lastGame.profit >= 300) {
                // ГАРАНТИРОВАННЫЙ СЛИВ на 1.00-1.06x
                return 1.00 + Math.random() * 0.06;
            }
            
            // Если нет ставок - стандартное распределение
            if (totalBetsAmount === 0) {
                return getStandardCrashPoint();
            }
            
            // АНАЛИЗ ИСТОРИИ КРАШ-ИКСОВ - избегаем монотонности
            const recentCrashes = crashHistory.slice(0, 5);
            const avgRecentCrash = recentCrashes.length > 0 
                ? recentCrashes.reduce((a, b) => a + b, 0) / recentCrashes.length 
                : 2.5;
            
            const lowCrashesCount = recentCrashes.filter(x => x < 1.8).length;
            const highCrashesCount = recentCrashes.filter(x => x >= 4).length;
            
            // Если было много низких крашей подряд - даем шанс на средний
            let bonusChance = 0;
            if (lowCrashesCount >= 3) {
                bonusChance = 0.2; // Бонус шанс
            }
            
            // Анализ истории игрока
            const recentGames = playerHistory.slice(-10);
            const totalProfit = recentGames.reduce((sum, g) => sum + g.profit, 0);
            const lastGames = recentGames.slice(-3);
            const recentWins = lastGames.filter(g => g.won).length;
            const lastGameProfit = lastGames.length > 0 ? lastGames[lastGames.length - 1].profit : 0;
            
            // Проверяем - все ли забрали
            const allCashedOut = currentBets.length > 0 && currentBets.every(b => b.cashedOut);
            const maxCashout = allCashedOut && currentBets.length > 0
                ? Math.max(...currentBets.map(b => b.cashoutMultiplier))
                : 0;
            
            // СПЕЦИАЛЬНАЯ ЛОГИКА: Если все забрали
            if (allCashedOut && maxCashout > 0) {
                const rand = Math.random();
                
                // Даем от последнего кэшаута +3x до +15x или до 100x
                if (rand < 0.05) {
                    // 5% шанс на огромный икс (до 100x)
                    return maxCashout + 10 + Math.random() * (100 - maxCashout - 10);
                } else if (rand < 0.15) {
                    // 10% шанс на +10x до +15x
                    return maxCashout + 10 + Math.random() * 5;
                } else if (rand < 0.35) {
                    // 20% шанс на +5x до +10x
                    return maxCashout + 5 + Math.random() * 5;
                } else {
                    // 65% шанс на +3x до +5x
                    return maxCashout + 3 + Math.random() * 2;
                }
            }
            
            // УСИЛЕННАЯ АНТИ-ВИННАЯ ЛОГИКА
            // Если игрок много выиграл за последние игры
            if (totalProfit > 1500) { // Было 2000, теперь 1500
                const rand = Math.random();
                if (rand < 0.70) return 1.00 + Math.random() * 0.5; // 1.0-1.5x (70%)
                if (rand < 0.92) return 1.5 + Math.random() * 0.7; // 1.5-2.2x (22%)
                return 2.2 + Math.random() * 0.8; // 2.2-3.0x (8%)
            }
            
            // Если последняя игра принесла много
            if (lastGameProfit > 1000) { // Было 1500, теперь 1000
                const rand = Math.random();
                if (rand < 0.75) return 1.00 + Math.random() * 0.6; // Слив 75%
                return 1.6 + Math.random() * 1.0; // 25% на 1.6-2.6x
            }
            
            // Если выиграл последние 2-3 игры подряд
            if (recentWins >= 2) {
                const rand = Math.random();
                if (rand < 0.70) return 1.00 + Math.random() * 0.7; // 1.0-1.7x (70%)
                if (rand < 0.92) return 1.7 + Math.random() * 0.9; // 1.7-2.6x (22%)
                return 2.6 + Math.random() * 1.4; // 2.6-4.0x (8%)
            }
            
            // СТАВКИ ПО РАЗМЕРУ
            
            // ОГРОМНЫЕ СТАВКИ (≥3000₽) - почти всегда слив
            if (totalBetsAmount >= 3000) {
                const rand = Math.random();
                if (rand < 0.52) return 1.00 + Math.random() * 0.6; // 1.0-1.6x (52%)
                if (rand < 0.80) return 1.6 + Math.random() * 0.6; // 1.6-2.2x (28%)
                if (rand < 0.94) return 2.2 + Math.random() * 0.8; // 2.2-3.0x (14%)
                return 3.0 + Math.random() * 1.5; // 3.0-4.5x (6%)
            }
            
            // БОЛЬШИЕ СТАВКИ (1500-3000₽)
            if (totalBetsAmount >= 1500) {
                const rand = Math.random();
                if (rand < 0.45) return 1.00 + Math.random() * 0.8; // 1.0-1.8x (45%)
                if (rand < 0.73) return 1.8 + Math.random() * 0.9; // 1.8-2.7x (28%)
                if (rand < 0.92) return 2.7 + Math.random() * 1.0; // 2.7-3.7x (19%)
                return 3.7 + Math.random() * 1.8; // 3.7-5.5x (8%)
            }
            
            // СРЕДНИЕ СТАВКИ (500-1500₽)
            if (totalBetsAmount >= 500) {
                const rand = Math.random() + bonusChance * 0.3;
                if (rand < 0.38) return 1.00 + Math.random() * 1.1; // 1.0-2.1x (38%)
                if (rand < 0.68) return 2.1 + Math.random() * 1.0; // 2.1-3.1x (30%)
                if (rand < 0.88) return 3.1 + Math.random() * 1.2; // 3.1-4.3x (20%)
                if (rand < 0.97) return 4.3 + Math.random() * 1.7; // 4.3-6.0x (9%)
                return 6.0 + Math.random() * 3.0; // 6.0-9.0x (3%)
            }
            
            // МАЛЫЕ СТАВКИ (200-500₽)
            if (totalBetsAmount >= 200) {
                const rand = Math.random() + bonusChance;
                if (rand < 0.46) return 1.00 + Math.random() * 1.2; // 1.0-2.2x (46%)
                if (rand < 0.73) return 2.2 + Math.random() * 1.3; // 2.2-3.5x (27%)
                if (rand < 0.90) return 3.5 + Math.random() * 2.5; // 3.5-6.0x (17%)
                if (rand < 0.97) return 6.0 + Math.random() * 4.0; // 6.0-10.0x (7%)
                return 10.0 + Math.random() * 8.0; // 10.0-18.0x (3%)
            }
            
            // ОЧЕНЬ МАЛЫЕ СТАВКИ (<200₽) - ЧУТЬ ЛУЧШЕ ШАНСЫ
            const rand = Math.random() + bonusChance * 1.2;
            
            if (rand < 0.55) {
                // 55% падает до 2.2x (было 60% до 2.0x)
                return 1.00 + Math.random() * 1.2; // 1.0-2.2x
            } else if (rand < 0.78) {
                // 23% → 2.2-4.5x
                return 2.2 + Math.random() * 2.3;
            } else if (rand < 0.92) {
                // 14% → 4.5-8.0x
                return 4.5 + Math.random() * 3.5;
            } else if (rand < 0.98) {
                // 6% → 8.0-15.0x
                return 8.0 + Math.random() * 7.0;
            } else {
                // 2% → 15.0-25.0x (максимум!)
                return 15.0 + Math.random() * 10.0;
            }
        }

        function getStandardCrashPoint() {
            const rand = Math.random() * 100;
            
            if (rand < 52) {
                // 1-2.2x (52%) - было 55% до 2.0x
                return 1.0 + Math.random() * 1.2;
            } else if (rand < 76) {
                // 2.2-3.8x (24%) - было 23% до 3.5x
                return 2.2 + Math.random() * 1.6;
            } else if (rand < 90) {
                // 3.8-6.5x (14%) - было 13% до 6.0x
                return 3.8 + Math.random() * 2.7;
            } else if (rand < 96) {
                // 6.5-13x (6%)
                return 6.5 + Math.random() * 6.5;
            } else if (rand < 99.2) {
                // 13-35x (3.2%)
                return 13.0 + Math.random() * 22.0;
            } else {
                // 35-100x (0.8%)
                return 35.0 + Math.random() * 65.0;
            }
        }

        // ==================== ИГРОВАЯ МЕХАНИКА ====================
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            startX = 120; // Было 80, теперь 120 - правее
            startY = canvas.height * 0.85; // Было 0.75, теперь 0.85 - НИЖЕ
            
            if (gamePhase === 'betting') {
                starX = startX;
                starY = startY;
            }
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ==================== ТАЙМЕР ====================
        function updateTimer() {
            if (gamePhase === 'betting') {
                timer -= 0.1;
                document.getElementById('timerValue').textContent = timer.toFixed(1);
                document.getElementById('timerValue').classList.add('betting');
                document.getElementById('timerLabel').textContent = 'До начала';
                
                if (timer <= 0) {
                    startFlying();
                }
            }
        }

        // ==================== СТАВКИ ====================
        function updateCrashHistory() {
            crashHistory.unshift(crashPoint);
            if (crashHistory.length > 7) crashHistory.pop(); // Максимум 7 иксов
            
            const historyContainer = document.getElementById('historyItems');
            historyContainer.innerHTML = crashHistory.map(x => {
                let className = 'low';
                if (x >= 10) className = 'mega';
                else if (x >= 3) className = 'high';
                else if (x >= 2) className = 'medium';
                
                return `<div class="history-item ${className}">${x.toFixed(2)}×</div>`;
            }).join('');
        }

        function addBotBet() {
            const amount = Math.floor(Math.random() * 800) + 100;
            const name = NAMES[Math.floor(Math.random() * NAMES.length)] + Math.floor(Math.random() * 999);
            
            currentBets.push({
                player: name,
                amount: amount,
                cashedOut: false,
                cashoutMultiplier: 0,
                isBot: true
            });
            
            renderBetsTable();
        }

        function renderBetsTable() {
            const table = document.getElementById('betsTable');
            table.innerHTML = currentBets.map(bet => {
                let statusText = 'Ждет...';
                let statusClass = '';
                
                if (bet.cashedOut) {
                    statusText = `${bet.cashoutMultiplier.toFixed(2)}×`;
                    statusClass = 'won';
                } else if (gamePhase === 'crashed') {
                    statusText = 'Проиграл';
                    statusClass = 'lost';
                }
                
                return `
                    <div class="bet-row">
                        <span class="bet-player">${bet.player}</span>
                        <span class="bet-amount">${bet.amount} ₽</span>
                        <span class="bet-multiplier ${statusClass}">${statusText}</span>
                    </div>
                `;
            }).join('');
        }

        // ==================== СТАРТ ПОЛЕТА ====================
        function startFlying() {
            gamePhase = 'flying';
            multiplier = 1.00;
            
            // Используем предрассчитанный краш-поинт или рассчитываем новый
            crashPoint = precalculatedCrashPoint || calculateCrashPoint();
            precalculatedCrashPoint = null; // Сбрасываем для следующего раунда
            
            // ФИКС: Устанавливаем стартовую позицию НИЖЕ и ПРАВЕЕ
            starX = 120; // Правее
            starY = canvas.height * 0.85; // НИЖЕ
            startX = 120;
            startY = canvas.height * 0.85;
            
            trail = [];
            particles = [];
            starRotation = 0;
            time = 0;
            
            initPlanets();
            
            document.getElementById('timerLabel').textContent = 'Статус';
            document.getElementById('timerValue').textContent = 'В полете';
            document.getElementById('timerValue').classList.remove('betting');
            document.getElementById('cashoutBtn').disabled = playerBet ? false : true;
        }

        // ==================== КРАШ ====================
        function crashGame() {
            gamePhase = 'crashed';
            
            updateCrashHistory(); // Добавляем в историю
            
            document.getElementById('multiplierDisplay').classList.add('crashed');
            document.getElementById('cashoutBtn').disabled = true;
            document.getElementById('currentProfit').classList.remove('show'); // Скрываем выигрыш
            
            // Сохранение истории игрока
            if (playerBet && !playerBet.cashedOut) {
                playerHistory.push({
                    won: false,
                    profit: -playerBet.amount,
                    multiplier: crashPoint
                });
            }
            
            renderBetsTable();
            createExplosion('#ff4444');
            
            setTimeout(() => {
                resetGame();
            }, 3000);
        }

        function resetGame() {
            gamePhase = 'betting';
            timer = 10.0;
            multiplier = 1.00;
            currentBets = [];
            playerBet = null;
            precalculatedCrashPoint = null; // Сбрасываем предрассчитанный краш-поинт
            
            // ФИКС: Принудительно устанавливаем стартовую позицию НИЖЕ и ПРАВЕЕ
            starX = 120; // Правее
            starY = canvas.height * 0.85; // НИЖЕ
            startX = 120;
            startY = canvas.height * 0.85;
            
            trail = [];
            particles = [];
            planets.forEach(p => p.visible = false);
            
            document.getElementById('multiplierDisplay').classList.remove('crashed');
            document.getElementById('multiplierDisplay').textContent = '1.00×';
            document.getElementById('playBtn').disabled = false;
            document.getElementById('cashoutBtn').disabled = true;
            document.getElementById('timerValue').classList.add('betting');
            
            renderBetsTable();
        }

        // ==================== ВИЗУАЛ ====================
        class Planet3D {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.baseRadius = Math.random() * 25 + 18; // Было 35+25, теперь меньше
                this.radius = this.baseRadius;
                this.rotationX = Math.random() * Math.PI * 2;
                this.rotationY = Math.random() * Math.PI * 2;
                this.rotationSpeedX = (Math.random() - 0.5) * 0.008;
                this.rotationSpeedY = (Math.random() - 0.5) * 0.008;
                this.visible = false;
                this.opacity = 0;
                
                const colors = [
                    { main: '#667eea', light: '#87ceeb', dark: '#2c3e70' },
                    { main: '#f093fb', light: '#fbc2eb', dark: '#8e2de2' },
                    { main: '#4facfe', light: '#00f2fe', dark: '#2874a6' },
                    { main: '#fa709a', light: '#fee140', dark: '#c0392b' }
                ];
                this.colors = colors[Math.floor(Math.random() * colors.length)];
            }

            update() {
                if (this.visible && this.opacity < 1) {
                    this.opacity += 0.02;
                }
                this.rotationX += this.rotationSpeedX;
                this.rotationY += this.rotationSpeedY;
            }

            draw() {
                if (!this.visible || this.opacity <= 0) return;
                
                ctx.save();
                ctx.globalAlpha = this.opacity;
                
                const gradient = ctx.createRadialGradient(
                    this.x - this.radius * 0.3,
                    this.y - this.radius * 0.3,
                    0,
                    this.x,
                    this.y,
                    this.radius
                );
                gradient.addColorStop(0, this.colors.light);
                gradient.addColorStop(0.5, this.colors.main);
                gradient.addColorStop(1, this.colors.dark);
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.globalAlpha = this.opacity * 0.3;
                ctx.strokeStyle = this.colors.light;
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.restore();
            }
        }

        class StarParticle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 3;
                this.vy = (Math.random() - 0.5) * 3;
                this.life = 1.0;
                this.size = Math.random() * 2 + 1;
                this.color = `hsl(${Math.random() * 60 + 40}, 100%, 60%)`;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= 0.018; // Плавное исчезновение
                this.vx *= 0.98; // Замедление
                this.vy *= 0.98;
            }

            draw() {
                if (this.life <= 0) return;
                
                ctx.save();
                ctx.globalAlpha = Math.max(0, this.life);
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size * this.life, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        function initStars() {
            stars = [];
            for (let i = 0; i < 150; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 2,
                    opacity: Math.random() * 0.5 + 0.3
                });
            }
        }

        function initPlanets() {
            planets = [];
            for (let i = 0; i < 5; i++) { // Было 8, теперь 5
                planets.push(new Planet3D(
                    canvas.width + Math.random() * 500,
                    Math.random() * canvas.height
                ));
            }
        }

        function drawSpace() {
            // Фон
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#0a0e1a');
            gradient.addColorStop(0.5, '#1a1f35');
            gradient.addColorStop(1, '#0f1419');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Звезды
            stars.forEach(star => {
                ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                ctx.fillRect(star.x, star.y, star.size, star.size);
            });
        }

        function drawMoon() {
            const moonX = canvas.width - 120;
            const moonY = 100;
            const moonRadius = 45;
            
            ctx.save();
            
            // Лунное сияние
            const glowGradient = ctx.createRadialGradient(moonX, moonY, moonRadius * 0.5, moonX, moonY, moonRadius * 2);
            glowGradient.addColorStop(0, 'rgba(200, 200, 255, 0.3)');
            glowGradient.addColorStop(1, 'rgba(200, 200, 255, 0)');
            ctx.fillStyle = glowGradient;
            ctx.beginPath();
            ctx.arc(moonX, moonY, moonRadius * 2, 0, Math.PI * 2);
            ctx.fill();
            
            // Луна
            const moonGradient = ctx.createRadialGradient(
                moonX - moonRadius * 0.3,
                moonY - moonRadius * 0.3,
                0,
                moonX,
                moonY,
                moonRadius
            );
            moonGradient.addColorStop(0, '#f0f0ff');
            moonGradient.addColorStop(1, '#c8c8e0');
            ctx.fillStyle = moonGradient;
            ctx.beginPath();
            ctx.arc(moonX, moonY, moonRadius, 0, Math.PI * 2);
            ctx.fill();
            
            // Кратеры
            ctx.fillStyle = 'rgba(150, 150, 180, 0.3)';
            ctx.beginPath();
            ctx.arc(moonX + 10, moonY - 10, 8, 0, Math.PI * 2);
            ctx.arc(moonX - 15, moonY + 12, 12, 0, Math.PI * 2);
            ctx.arc(moonX + 18, moonY + 15, 6, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
        }

        function drawStar(x, y, size, rotation) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(rotation);
            
            // Звездное сияние
            const glowGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, size * 2);
            glowGradient.addColorStop(0, 'rgba(255, 215, 0, 0.5)');
            glowGradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
            ctx.fillStyle = glowGradient;
            ctx.beginPath();
            ctx.arc(0, 0, size * 2, 0, Math.PI * 2);
            ctx.fill();
            
            // Пятиконечная звезда
            ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                const angle = (i * 4 * Math.PI) / 5 - Math.PI / 2;
                const xPos = Math.cos(angle) * size;
                const yPos = Math.sin(angle) * size;
                if (i === 0) ctx.moveTo(xPos, yPos);
                else ctx.lineTo(xPos, yPos);
            }
            ctx.closePath();
            
            const starGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, size);
            starGradient.addColorStop(0, '#fff9c4');
            starGradient.addColorStop(0.5, '#ffd700');
            starGradient.addColorStop(1, '#ffb700');
            ctx.fillStyle = starGradient;
            ctx.fill();
            
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.restore();
        }

        function createExplosion(color) {
            for (let i = 0; i < 50; i++) {
                const particle = new StarParticle(starX, starY);
                const angle = (i / 50) * Math.PI * 2;
                const speed = Math.random() * 8 + 4;
                particle.vx = Math.cos(angle) * speed;
                particle.vy = Math.sin(angle) * speed;
                particle.color = color;
                particles.push(particle);
            }
        }

        // ==================== ГЛАВНЫЙ ЦИКЛ ====================
        function gameLoop() {
            time++;
            moonAngle += 0.004;
            
            drawSpace();
            drawMoon();
            
            // Обновление планет
            planets.forEach(planet => {
                planet.update();
                planet.draw();
            });
            
            // Логика полета
            if (gamePhase === 'flying') {
                // ЕЩЕ МЕДЛЕННЕЕ В НАЧАЛЕ
                let growthRate;
                if (multiplier < 1.3) {
                    growthRate = 0.0008; // Очень медленно до 1.3x
                } else if (multiplier < 2.0) {
                    growthRate = 0.0015; // Медленно до 2.0x
                } else if (multiplier < 3.0) {
                    growthRate = 0.0025; // Средне до 3.0x
                } else if (multiplier < 5.0) {
                    growthRate = 0.0038; // Быстрее до 5x
                } else if (multiplier < 10.0) {
                    growthRate = 0.006; // Быстро до 10x
                } else {
                    growthRate = 0.01; // Очень быстро после 10x
                }
                
                multiplier += growthRate * (1 + multiplier * 0.06); // Было 0.08, теперь 0.06
                document.getElementById('multiplierDisplay').textContent = multiplier.toFixed(2) + '×';
                
                // ОБНОВЛЕНИЕ ТЕКУЩЕГО ВЫИГРЫША
                if (playerBet && !playerBet.cashedOut) {
                    const totalAmount = Math.floor(playerBet.amount * multiplier);
                    
                    document.getElementById('currentProfit').classList.add('show');
                    document.getElementById('profitAmount').textContent = `${totalAmount} ₽`;
                } else {
                    document.getElementById('currentProfit').classList.remove('show');
                }
                
                // Множитель скорости визуального движения
                let speedMultiplier;
                if (multiplier < 2) {
                    speedMultiplier = 1.0;
                } else if (multiplier < 5) {
                    speedMultiplier = 1.3;
                } else if (multiplier < 10) {
                    speedMultiplier = 1.7;
                } else {
                    speedMultiplier = 2.2;
                }
                
                const speedFactor = 1 + multiplier * 0.08;
                
                // АВТО-СТОП ЛОГИКА
                const autoStopEnabled = document.getElementById('autoStopToggle').classList.contains('active');
                if (autoStopEnabled && playerBet && !playerBet.cashedOut) {
                    const autoStopValue = parseFloat(document.getElementById('autoStopValue').value);
                    if (multiplier >= autoStopValue) {
                        // Автоматический кэшаут
                        playerBet.cashedOut = true;
                        playerBet.cashoutMultiplier = multiplier;
                        
                        const profit = playerBet.amount * multiplier - playerBet.amount;
                        playerHistory.push({
                            won: true,
                            profit: profit,
                            multiplier: multiplier
                        });
                        
                        renderBetsTable();
                        createExplosion('#00ff88');
                        document.getElementById('cashoutBtn').disabled = true;
                        document.getElementById('currentProfit').classList.remove('show'); // Скрываем выигрыш
                    }
                }
                
                // Движение звезды вверх и вправо - ускоряется с множителем
                starX += 1.8 * speedFactor * speedMultiplier;
                starY -= 0.8 * speedFactor * speedMultiplier; // Постепенный подъем вверх
                
                // Волновой эффект
                starY += Math.sin(time * 0.05) * 1.2;
                
                starRotation += 0.1 * speedMultiplier;
                
                // След - меньше точек при высокой скорости
                const maxTrailLength = multiplier < 5 ? 30 : 20;
                trail.push({ x: starX, y: starY });
                if (trail.length > maxTrailLength) trail.shift();
                
                // Частицы хвоста
                if (time % 4 === 0) { // Было % 3, теперь реже
                    const p = new StarParticle(starX - 5, starY); // Сдвигаем назад
                    p.vx = -2.5 * speedFactor * speedMultiplier; // Учитываем скорость
                    p.vy = (Math.random() - 0.5) * 0.4;
                    p.size = 1.0 + Math.random() * 0.5;
                    p.life = 0.95; // Чуть меньше жизни
                    particles.push(p);
                }
                
                // Проверка краша
                if (multiplier >= crashPoint) {
                    crashGame();
                }
                
                // Появление планет (реже) - между звездой и луной
                if (Math.floor(multiplier * 2) % 3 === 0 && Math.random() < 0.02) {
                    const availablePlanet = planets.find(p => !p.visible);
                    if (availablePlanet) {
                        let attempts = 0;
                        let validPosition = false;
                        let newX, newY;
                        
                        // Пытаемся найти позицию без наложения
                        while (!validPosition && attempts < 10) {
                            newX = starX + 400 + Math.random() * 400;
                            // Планеты между 40% и 70% высоты экрана (между звездой и луной)
                            newY = canvas.height * 0.4 + Math.random() * (canvas.height * 0.3);
                            
                            // Проверяем расстояние от других видимых планет
                            validPosition = true;
                            for (let p of planets) {
                                if (p.visible && p !== availablePlanet) {
                                    const dx = p.x - newX;
                                    const dy = p.y - newY;
                                    const distance = Math.sqrt(dx * dx + dy * dy);
                                    
                                    // Минимальное расстояние между планетами - увеличено
                                    if (distance < 220) {
                                        validPosition = false;
                                        break;
                                    }
                                }
                            }
                            attempts++;
                        }
                        
                        if (validPosition) {
                            availablePlanet.x = newX;
                            availablePlanet.y = newY;
                            availablePlanet.visible = true;
                            availablePlanet.opacity = 0;
                        }
                    }
                }
                
                // Движение фона - быстрее при больших иксах
                if (starX > canvas.width / 2) {
                    stars.forEach(star => {
                        star.x -= 0.5 * speedFactor * speedMultiplier;
                        if (star.x < 0) star.x = canvas.width;
                    });
                    
                    planets.forEach(planet => {
                        if (planet.visible) {
                            planet.x -= 0.8 * speedFactor * speedMultiplier;
                        }
                    });
                    
                    starX = Math.min(starX, canvas.width - 200);
                }
                
                // Ограничение по Y - больше места для подъема
                starY = Math.max(canvas.height * 0.35, Math.min(starY, canvas.height * 0.90));
            }
            
            // Рисование следа
            if (trail.length > 1 && gamePhase === 'flying') {
                const gradient = ctx.createLinearGradient(
                    trail[trail.length - 1].x, trail[trail.length - 1].y,
                    trail[0].x, trail[0].y
                );
                gradient.addColorStop(0, 'rgba(255, 215, 0, 0.8)');
                gradient.addColorStop(0.5, 'rgba(255, 215, 0, 0.4)');
                gradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
                
                ctx.strokeStyle = gradient;
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.beginPath();
                ctx.moveTo(trail[0].x, trail[0].y);
                for (let i = 1; i < trail.length; i++) {
                    ctx.lineTo(trail[i].x, trail[i].y);
                }
                ctx.stroke();
            }
            
            // Частицы
            particles = particles.filter(p => {
                p.update();
                p.draw();
                return p.life > 0;
            });
            
            // Звезда
            if (gamePhase !== 'crashed') {
                drawStar(starX, starY, 28, starRotation);
            }
            
            requestAnimationFrame(gameLoop);
        }

        // ==================== ОБРАБОТЧИКИ ====================
        document.getElementById('playBtn').addEventListener('click', () => {
            if (gamePhase !== 'betting') return;
            
            const amount = parseInt(document.getElementById('betAmount').value);
            if (amount < 10) {
                alert('Минимальная ставка 10₽');
                return;
            }
            
            playerBet = {
                player: 'Вы',
                amount: amount,
                cashedOut: false,
                cashoutMultiplier: 0,
                isBot: false
            };
            
            currentBets.unshift(playerBet);
            
            // РАССЧИТЫВАЕМ КРАШ-ПОИНТ СРАЗУ ПРИ СТАВКЕ
            if (!precalculatedCrashPoint) {
                precalculatedCrashPoint = calculateCrashPoint();
            }
            
            renderBetsTable();
            
            document.getElementById('playBtn').disabled = true;
        });

        document.getElementById('cashoutBtn').addEventListener('click', () => {
            if (gamePhase !== 'flying' || !playerBet || playerBet.cashedOut) return;
            
            playerBet.cashedOut = true;
            playerBet.cashoutMultiplier = multiplier;
            
            const profit = playerBet.amount * multiplier - playerBet.amount;
            playerHistory.push({
                won: true,
                profit: profit,
                multiplier: multiplier
            });
            
            renderBetsTable();
            createExplosion('#00ff88');
            
            document.getElementById('cashoutBtn').disabled = true;
            document.getElementById('currentProfit').classList.remove('show'); // Скрываем выигрыш
        });

        document.getElementById('autoStopToggle').addEventListener('click', function() {
            this.classList.toggle('active');
            const inputGroup = document.getElementById('autoStopInputGroup');
            inputGroup.style.display = this.classList.contains('active') ? 'flex' : 'none';
        });

        // ==================== ИНИЦИАЛИЗАЦИЯ ====================
        initStars();
        initPlanets();
        
        starX = startX;
        starY = startY;
        
        // Инициализация истории с примерами (7 иксов)
        crashHistory = [2.45, 1.85, 5.67, 1.23, 3.12, 1.67, 8.90];
        
        // Отображение истории
        const historyContainer = document.getElementById('historyItems');
        historyContainer.innerHTML = crashHistory.map(x => {
            let className = 'low';
            if (x >= 10) className = 'mega';
            else if (x >= 3) className = 'high';
            else if (x >= 2) className = 'medium';
            
            return `<div class="history-item ${className}">${x.toFixed(2)}×</div>`;
        }).join('');
        
        setInterval(updateTimer, 100);
        gameLoop();
    </script>
</body>
</html>
