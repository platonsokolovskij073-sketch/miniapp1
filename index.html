<!DOCTYPE html>
<html lang="ru" class="nocopy"><!-- –∫–ª–∞—Å—Å –≤–∫–ª—é—á–∞–µ—Ç –∞–Ω—Ç–∏‚Äë–∫–æ–ø–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é -->
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="color-scheme" content="dark light" />
<title>Starify ‚Äî MiniApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0a12; --bg2:#140f1f; --text:#f7f4ff; --muted:#b7abc9;
  --line:rgba(255,255,255,.10); --card:rgba(255,255,255,.06);
  --orange:#ff7a18; --orange2:#ffb86b; --violet:#9c5cff; --violet2:#c39aff;
  --danger:#ff3b6b; --ok:#35ffb1; --shadow:0 20px 40px rgba(0,0,0,.35);
}

/* ---------- –ê–ù–¢–ò-–ö–û–ü–ò (–∂—ë—Å—Ç–∫–æ) ---------- */
/* MDN –ø–æ user-select / overscroll-behavior / rAF —Å–º. —Ü–∏—Ç–∞—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ */
html.nocopy, html.nocopy body, html.nocopy *:not(input):not(textarea){
  -webkit-user-select:none; user-select:none;
  -webkit-touch-callout:none;
}
html.nocopy ::selection{background:transparent}
html.nocopy body{ -webkit-tap-highlight-color: transparent; }
html,body{height:100%}
*{box-sizing:border-box}

body{
  margin:0; font-family:"Inter",system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
  background:
    radial-gradient(900px 400px at 110% -10%, rgba(156,92,255,.22), transparent 60%),
    radial-gradient(1200px 600px at -10% 10%, rgba(255,122,24,.18), transparent 60%),
    linear-gradient(180deg,var(--bg),var(--bg2));
  display:flex; flex-direction:column;
  overscroll-behavior: none; /* –∏–∑–±–µ–≥–∞–µ–º ¬´–ø—Ä–æ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è¬ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–≤–µ—Ä—Ö —Å—Ü–µ–Ω */
}

/* --- Layout / spacing --- */
.header{
  position:sticky; top:0; z-index:10;
  padding:14px 16px; display:flex; align-items:center; gap:12px;
  background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.2));
  backdrop-filter:blur(14px) saturate(140%); -webkit-backdrop-filter:blur(14px) saturate(140%);
  border-bottom:1px solid var(--line);
}
.page{flex:1; display:flex; flex-direction:column}
.container{
  width:100%; max-width:860px; margin:0 auto;
  padding:14px 14px 90px;
  display:none; animation:fade .25s ease forwards;
}
.container.active{display:block}

.logo{width:36px; height:36px; border-radius:12px; display:grid; place-items:center; font-weight:800;
  background:conic-gradient(from 0deg, var(--orange2), var(--orange), var(--violet), var(--orange2));
  color:#150b00; box-shadow:var(--shadow)}
.title{font-weight:800; letter-spacing:.3px}
.subtitle{font-size:12px; color:var(--muted)}

.grid{display:grid; gap:12px}
.grid.cols-2{grid-template-columns:1fr}
@media (min-width:520px){ .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))} }

.card{
  background:var(--card); border:1px solid var(--line); border-radius:18px; padding:14px; box-shadow:var(--shadow);
  transition:.25s transform,.25s background,.25s box-shadow;
}
.card:hover{transform:translateY(-2px)}
.card h3{margin:.2rem 0 .4rem; font-size:16px}
.card p{margin:0; font-size:12px; color:var(--muted)}
.hr{height:1px; background:var(--line); margin:8px 0 2px}
.row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
.tile{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px; border-radius:14px; background:rgba(255,255,255,.06); border:1px solid var(--line)}

/* --- Inputs --- */
.input{
  width:100%; padding:12px 12px; border-radius:14px;
  border:1px solid var(--line); background:rgba(255,255,255,.06);
  color:var(--text); outline:none; background-clip:padding-box;
  transition:border-color .2s, box-shadow .2s, transform .1s;
}
.input[type=number]::-webkit-outer-spin-button,
.input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
.input[type=number]{ -moz-appearance:textfield }
.input:focus{
  border-color: rgba(255,186,107,.6);
  box-shadow:0 0 0 6px rgba(255,122,24,.15);
  transform:translateY(-1px);
}

/* --- Buttons --- */
.btn{
  appearance:none; border:0; cursor:pointer; padding:12px 14px; border-radius:14px; font-weight:800;
  color:#1b0b00; background:linear-gradient(135deg, var(--orange), var(--orange2));
  box-shadow:0 12px 26px rgba(255,122,24,.35); transition:transform .12s,filter .2s, box-shadow .2s;
}
.btn:active{transform:scale(.98)}
.btn.purple{background:linear-gradient(135deg, var(--violet), var(--violet2)); color:#0c0216; box-shadow:0 12px 26px rgba(156,92,255,.35)}
.btn.ghost{background:transparent; color:var(--text); border:1px solid var(--line); box-shadow:none}
.badge{font-size:12px; padding:6px 8px; border-radius:10px; background:rgba(255,255,255,.10); border:1px solid var(--line); color:var(--muted)}
.bigbtn{display:flex; gap:12px}
.bigbtn .btn{flex:1; font-size:15px}

/* --- Bottom nav --- */
.nav{
  position:sticky; bottom:0; z-index:10;
  display:grid; grid-template-columns:repeat(5,1fr); gap:8px; padding:10px;
  background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.55));
  backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
  border-top:1px solid var(--line);
}
.tab{
  appearance:none; border:1px solid var(--line); background:rgba(255,255,255,.06); color:#fff;
  padding:12px 8px; border-radius:16px; font-size:12px; display:flex; flex-direction:column; align-items:center; gap:4px
}
.tab span{opacity:.85; font-size:11px}
.tab.active{background:linear-gradient(135deg, rgba(255,122,24,.18), rgba(156,92,255,.18))}

/* --- Stage (–∏–≥—Ä–æ–≤–æ–µ –æ–∫–Ω–æ) --- */
.stage{
  position:relative; height:240px; border-radius:16px; background:rgba(255,255,255,.06);
  border:1px solid var(--line); overflow:hidden; /* –∫—Ä–∏—Ç–∏—á–Ω–æ! */
  touch-action: none; /* –±–µ–∑ —Å–ª—É—á–∞–π–Ω—ã—Ö –∂–µ—Å—Ç–æ–≤/—Å–∫—Ä–æ–ª–ª–∞ –ø–æ–≤–µ—Ä—Ö —Å—Ü–µ–Ω—ã */
}
.hoop{position:absolute; right:18px; top:38px; font-size:36px; filter:drop-shadow(0 4px 6px rgba(0,0,0,.4))}
.ball,.dart,.bowl{position:absolute; will-change:transform}
.ball{font-size:44px}
.bowl{font-size:44px}
.pin{position:absolute; font-size:32px; will-change:transform}
.target{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  width:170px; height:170px; border-radius:50%;
  background:
    radial-gradient(circle at center, #d41414 0 12%, #fff 12% 24%, #d41414 24% 36%, #fff 36% 48%, #d41414 48% 60%, transparent 60%);
  box-shadow:0 0 0 6px #ffffff22 inset, 0 10px 30px rgba(0,0,0,.25);
}

/* --- Slot --- */
.slot-wrap{display:grid; place-items:center; gap:10px}
.slot{width:300px; height:120px; border-radius:16px; overflow:hidden;
  background:rgba(0,0,0,.35); border:1px solid var(--line); box-shadow:var(--shadow);
  display:grid; grid-template-columns:repeat(3,1fr); gap:8px; padding:8px}
.reel{position:relative; overflow:hidden; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.08); display:grid; place-items:center}
.roller{position:absolute; left:0; right:0; top:0; will-change:transform}
.symbol{height:48px; display:grid; place-items:center; font-size:36px;}

/* Toast */
.toast{position:fixed; left:50%; bottom:120px; transform:translateX(-50%) translateY(20px); background:rgba(0,0,0,.8);
  border:1px solid var(--line); color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; transition:opacity .2s, transform .2s; font-size:13px}
.toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
@keyframes fade{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}
</style>
</head>
<body>
  <div class="header">
    <div class="logo">ü¶á</div>
    <div>
      <div class="title">Starify</div>
      <div class="subtitle">–º–∞–≥–∞–∑–∏–Ω ‚Ä¢ –º–∏–Ω–∏-–∏–≥—Ä—ã ‚Ä¢ —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∞</div>
    </div>
    <div style="margin-left:auto" class="badge" id="userBadge">@guest</div>
  </div>

  <div class="page">
    <!-- HOME -->
    <section class="container active" id="home">
      <div class="card">
        <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Starify üéÉ</h3>
        <div class="bigbtn" style="margin-top:10px">
          <button class="btn" data-tab-go="shop">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
          <button class="btn purple" data-tab-go="games">üé≤ –ò–≥—Ä—ã</button>
          <button class="btn ghost" data-tab-go="ref">ü§ù –†–µ—Ñ–µ—Ä–∞–ª–∫–∞</button>
        </div>
      </div>
    </section>

    <!-- SHOP -->
    <section class="container" id="shop">
      <div class="card">
        <h3>–ú–∞–≥–∞–∑–∏–Ω</h3>
        <p>–í—ã–±–µ—Ä–∏ –∑–≤—ë–∑–¥—ã –∏–ª–∏ Premium. –°—Ä–∞–∑—É –ø–µ—Ä–µ–π–¥—ë–º –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é.</p>
        <div class="hr"></div>

        <div class="grid cols-2" style="margin-top:6px">
          <!-- Stars -->
          <div class="card" style="background:linear-gradient(180deg,rgba(255,122,24,.10),rgba(255,255,255,.06))">
            <h3>‚≠ê –ó–≤—ë–∑–¥—ã</h3>
            <div class="grid" id="starsQuick"></div>
            <div class="hr"></div>
            <div class="tile">
              <div style="flex:1">
                <div class="badge" style="margin-bottom:6px">–î—Ä—É–≥–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                <input id="customStars" class="input" type="number" min="1" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">
              </div>
              <button class="btn purple" id="buyCustomStars">–£–∫–∞–∑–∞—Ç—å</button>
            </div>
          </div>

          <!-- Premium -->
          <div class="card" style="background:linear-gradient(180deg,rgba(156,92,255,.12),rgba(255,255,255,.06))">
            <h3>üíé Premium</h3>
            <div class="grid" id="premiumPlans"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- CHECKOUT -->
    <section class="container" id="checkout">
      <div class="card">
        <h3>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h3>
        <p id="checkoutWhat">–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä</p>
        <div class="hr"></div>
        <div class="grid">
          <input id="username" class="input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ @username –ø–æ–ª—É—á–∞—Ç–µ–ª—è">
          <input id="amount" class="input" type="number" min="1" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–¥–ª—è –∑–≤—ë–∑–¥)">
          <button class="btn" id="proceed">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          <button class="btn ghost" data-tab-go="shop">–ù–∞–∑–∞–¥ –≤ –º–∞–≥–∞–∑–∏–Ω</button>
        </div>
      </div>
    </section>

    <!-- GAMES -->
    <section class="container" id="games">
      <div class="card">
        <h3>–ú–∏–Ω–∏-–∏–≥—Ä—ã</h3>
        <div class="row" style="margin-top:8px">
          <button class="btn" data-game="slot">üé∞ –°–ª–æ—Ç</button>
          <button class="btn purple" data-game="basket">üèÄ –ë–∞—Å–∫–µ—Ç–±–æ–ª</button>
          <button class="btn ghost" data-game="bowling">üé≥ –ë–æ—É–ª–∏–Ω–≥</button>
          <button class="btn ghost" data-game="darts">üéØ –î–∞—Ä—Ç—Å</button>
        </div>
      </div>

      <!-- Game container -->
      <div id="gameArea" class="grid" style="margin-top:6px"></div>
    </section>

    <!-- REF -->
    <section class="container" id="ref">
      <div class="card">
        <h3>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h3>
        <p>–ü–æ–¥–µ–ª–∏—Å—å —Å—Å—ã–ª–∫–æ–π ‚Äî –¥—Ä—É–≥ –ø–æ–ª—É—á–∏—Ç –±–æ–Ω—É—Å, –∞ —Ç—ã –±–æ–Ω—É—Å –∑–≤—ë–∑–¥–∞–º–∏.</p>
        <div class="hr"></div>
        <div class="row" style="margin-top:8px">
          <input id="refLink" class="input" readonly value="https://t.me/your_bot_here?start=ref_0000">
          <button class="btn purple" id="copyRef">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section class="container" id="profile">
      <div class="card">
        <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
        <p id="whoami">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–¥—Ç—è–Ω–µ—Ç—Å—è –∏–∑ Telegram, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ.</p>
        <div class="row" style="margin-top:8px">
          <button class="btn ghost" id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å MiniApp</button>
        </div>
      </div>
    </section>
  </div>

  <!-- NAV -->
  <nav class="nav">
    <button class="tab active" data-tab="home">üè†<span>–î–æ–º</span></button>
    <button class="tab" data-tab="shop">üõí<span>–ú–∞–≥–∞–∑–∏–Ω</span></button>
    <button class="tab" data-tab="games">üé≤<span>–ò–≥—Ä—ã</span></button>
    <button class="tab" data-tab="ref">ü§ù<span>–†–µ—Ñ–µ—Ä–∞–ª–∫–∞</span></button>
    <button class="tab" data-tab="profile">üë§<span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  </nav>

  <div class="toast" id="toast">–ì–æ—Ç–æ–≤–æ!</div>

<script>
/* -----------------------------------------------------------
   Telegram + —Ç–µ–º—ã
----------------------------------------------------------- */
const tg = window.Telegram?.WebApp;
function applyTheme(){
  if(!tg) return;
  const t = tg.themeParams || {};
  document.documentElement.style.setProperty('--line', t.section_separator_color || 'rgba(255,255,255,.10)');
}
(function hydrateUser(){
  try{
    const user = tg?.initDataUnsafe?.user;
    if(user){
      document.getElementById('userBadge').textContent = user.username ? '@'+user.username : (user.first_name||'user');
      document.getElementById('whoami').textContent = `–¢—ã: ${user.first_name||''} ${user.last_name||''} ${user.username?'(@'+user.username+')':''}`;
      const link = `https://t.me/${tg?.initDataUnsafe?.receiver?.username || 'your_bot_here'}?start=ref_${user.id}`;
      document.getElementById('refLink').value = link;
    }
  }catch{}
})();

/* -----------------------------------------------------------
   –£—Ç–∏–ª–∏—Ç—ã UI
----------------------------------------------------------- */
const toast=(m='–ì–æ—Ç–æ–≤–æ!')=>{const el=document.getElementById('toast'); el.textContent=m; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1100);};
function openTab(id){document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===id)); document.querySelectorAll('.container').forEach(s=>s.classList.toggle('active',s.id===id));}
document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>openTab(t.dataset.tab));
document.querySelectorAll('[data-tab-go]').forEach(b=>b.onclick=()=>openTab(b.dataset.tabGo));

/* -----------------------------------------------------------
   –ú–∞–≥–∞–∑–∏–Ω
----------------------------------------------------------- */
const starsQuick=[500,1000,2500,5000];
const plans=[{name:'1 –º–µ—Å—è—Ü',plan:'1m'},{name:'3 –º–µ—Å—è—Ü–∞',plan:'3m'},{name:'6 –º–µ—Å—è—Ü–µ–≤',plan:'6m'},{name:'12 –º–µ—Å—è—Ü–µ–≤',plan:'12m'}];

const elStarsQuick=document.getElementById('starsQuick');
starsQuick.forEach(q=>{
  const c=document.createElement('div'); c.className='tile';
  c.innerHTML=`<div>‚≠ê ${q.toLocaleString('ru-RU')}</div><button class="btn" data-buy-stars="${q}">–ö—É–ø–∏—Ç—å</button>`;
  elStarsQuick.appendChild(c);
});
const elPlans=document.getElementById('premiumPlans');
plans.forEach(p=>{
  const c=document.createElement('div'); c.className='tile';
  c.innerHTML=`<div>${p.name}</div><button class="btn purple" data-buy-premium="${p.plan}">–ö—É–ø–∏—Ç—å</button>`;
  elPlans.appendChild(c);
});

let checkoutState={type:null, label:'', qty:null, plan:null};
function goCheckout(state){
  checkoutState=state;
  const what=document.getElementById('checkoutWhat');
  const amount=document.getElementById('amount');
  if(state.type==='stars'){
    what.textContent=`–ü–æ–∫—É–ø–∫–∞ –∑–≤—ë–∑–¥: ${state.qty? state.qty+' ‚≠ê' : '—É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∏–∂–µ'}`;
    amount.value = state.qty || '';
    amount.placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥";
    amount.parentElement.style.display='';
  } else {
    what.textContent=`–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ Telegram Premium: ${state.plan}`;
    amount.value=''; amount.parentElement.style.display='none';
  }
  openTab('checkout'); document.getElementById('username').focus();
}
document.addEventListener('click',(e)=>{
  const s=e.target.closest('[data-buy-stars]'); const p=e.target.closest('[data-buy-premium]');
  if(s){ goCheckout({type:'stars', label:'–ó–≤—ë–∑–¥—ã', qty:parseInt(s.dataset.buyStars,10)}); }
  if(p){ goCheckout({type:'premium', label:'Premium', plan:p.dataset.buyPremium}); }
});
document.getElementById('buyCustomStars').onclick=()=>{
  const qty=parseInt(document.getElementById('customStars').value,10) || null;
  goCheckout({type:'stars', label:'–ó–≤—ë–∑–¥—ã', qty});
};
document.getElementById('proceed').onclick=()=>{
  const u=(document.getElementById('username').value.trim()||'@username');
  const qty=document.getElementById('amount').parentElement.style.display==='none' ? '' : ` ‚Ä¢ ${document.getElementById('amount').value||checkoutState.qty||0} ‚≠ê`;
  toast(`–ó–∞—è–≤–∫–∞: ${checkoutState.label} ‚Üí ${u}${qty}`);
};

/* -----------------------------------------------------------
   –ê–ù–¢–ò-–ö–û–ü–ò (JS –∑–∞—â–∏—Ç–∞)
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ copy/cut, –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é, selectstart
   - –ë–ª–æ–∫ hotkeys: Ctrl/Cmd+C/X/A/S/P/U
   –°–º. MDN: user-select, copy event, preventDefault, rAF. :contentReference[oaicite:1]{index=1}
----------------------------------------------------------- */
(function antiCopy(){
  const allowSelectionOnInputs = false; // –µ—Å–ª–∏ true ‚Äî —Ä–∞–∑—Ä–µ—à–∏—Ç –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ <input>/<textarea>
  document.addEventListener('contextmenu', e=>e.preventDefault(), {passive:false});
  document.addEventListener('copy', e=>{ e.preventDefault(); toast('–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ'); }, {passive:false});
  document.addEventListener('cut',  e=>{ e.preventDefault(); }, {passive:false});
  document.addEventListener('selectstart', e=>{
    if(allowSelectionOnInputs){
      const t=e.target;
      if(t && (t.tagName==='INPUT' || t.tagName==='TEXTAREA')) return;
    }
    e.preventDefault();
  }, {passive:false});

  document.addEventListener('keydown', e=>{
    const k=e.key?.toLowerCase?.()||'';
    if((e.ctrlKey||e.metaKey) && ['c','x','a','s','p','u'].includes(k)){ e.preventDefault(); }
  });
})();

/* -----------------------------------------------------------
   –ò–≥—Ä—ã: –¥–≤–∏–∂–æ–∫, –∫–ª–∞–º–ø–∏–Ω–≥, –ø—Ä–µ—Å–µ—Ç—ã
----------------------------------------------------------- */
const gameArea=document.getElementById('gameArea');
const symbols=['üéÉ','üï∑Ô∏è','ü¶á','üï∏Ô∏è','üç¨','7Ô∏è‚É£'];

/* –ú–∞—Ç–µ–º. —É—Ç–∏–ª–∏—Ç—ã */
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const rand=(a,b)=>Math.random()*(b-a)+a;
const rint=(a,b)=>Math.floor(rand(a,b+1));
const easeOut=t=>1-Math.pow(1-t,3);

/* –û–±—â–∏–π ¬´—Å–ø—Ä–∞–π—Ç¬ª */
function makeSprite(el, stage){
  const W = ()=>stage.clientWidth, H=()=>stage.clientHeight;
  const rect=()=>el.getBoundingClientRect();
  const size=()=>({w:rect().width||40,h:rect().height||40});
  let x=0,y=0;

  function setPos(nx,ny){
    const {w,h}=size();
    x=clamp(nx, 0, W()-w);
    y=clamp(ny, 0, H()-h);
    el.style.transform=`translate(${x}px,${y}px)`;
    return {x,y};
  }
  function get(){ return {x,y,...size(),W:W(),H:H()}; }
  return {set:setPos, get};
}

/* –ú–∞—Å—Å–æ–≤—ã–µ –ø—Ä–æ–≥–æ–Ω—ã */
function makeControls(container, startOnce){
  const bar=document.createElement('div');
  bar.className='row';
  bar.style.marginTop='8px';
  bar.innerHTML=`
    <div class="badge">–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫</div>
    <div style="display:flex; gap:8px">
      <button class="btn ghost" data-run="1">‚ñ∂ 1</button>
      <button class="btn ghost" data-run="10">‚ñ∂√ó10</button>
      <button class="btn ghost" data-run="100">‚ñ∂√ó100</button>
      <button class="btn" data-stop>‚èπ –°—Ç–æ–ø</button>
    </div>`;
  container.appendChild(bar);

  let stop=false;
  bar.querySelector('[data-stop]').onclick=()=>{ stop=true; toast('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'); };

  bar.querySelectorAll('[data-run]').forEach(btn=>{
    btn.onclick=async()=>{
      stop=false;
      const times=parseInt(btn.dataset.run,10);
      for(let i=0;i<times;i++){
        if(stop) break;
        await startOnce();
        await new Promise(r=>setTimeout(r,150)); // –º–∞–ª–µ–Ω—å–∫–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Ä–∞–Ω–∞–º–∏
      }
      if(!stop) toast(`–ì–æ—Ç–æ–≤–æ: ${times} –∑–∞–ø—É—Å–∫(–æ–≤)`);
    };
  });
}

/* ---------- SLOT ---------- */
function mountSlot(){
  gameArea.innerHTML='';
  const wrap=document.createElement('div'); wrap.className='card slot-wrap';
  wrap.innerHTML=`
    <div class="slot">
      <div class="reel"><div class="roller" id="sl_r1"></div></div>
      <div class="reel"><div class="roller" id="sl_r2"></div></div>
      <div class="reel"><div class="roller" id="sl_r3"></div></div>
    </div>
    <div class="row"><button class="btn" id="spinBtn">Spin</button></div>
    <span class="badge" id="slotOut">–£–¥–∞—á–∏!</span>`;
  gameArea.appendChild(wrap);
  ['sl_r1','sl_r2','sl_r3'].forEach(id=>{
    const r=document.getElementById(id);
    r.innerHTML = symbols.concat(symbols, symbols).map(s=>`<div class="symbol">${s}</div>`).join('');
  });

  const rollers=[document.getElementById('sl_r1'),document.getElementById('sl_r2'),document.getElementById('sl_r3')];
  const itemH=48;
  function spinRoller(el, duration, extraCycles=6){
    const cycles=extraCycles+Math.floor(Math.random()*4);
    const total=cycles*symbols.length*itemH + (Math.floor(Math.random()*symbols.length))*itemH;
    const t0=performance.now();
    return new Promise(res=>{
      function step(now){
        const p=clamp((now-t0)/duration,0,1);
        const y=easeOut(p)*total;
        el.style.transform=`translateY(-${y}px)`;
        if(p<1) requestAnimationFrame(step);
        else {
          // —Ç–æ—á–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è –Ω–∞ —è—á–µ–π–∫–µ
          const rest = Math.round(y/itemH)*itemH;
          el.style.transform=`translateY(-${rest}px)`;
          res((rest/itemH)%symbols.length);
        }
      }
      requestAnimationFrame(step);
    });
  }
  async function spinOnce(){
    const out=document.getElementById('slotOut'); out.textContent='–ö—Ä—É—Ç–∏–º...';
    const i1=await spinRoller(rollers[0], 820, rint(6,8));
    const i2=await spinRoller(rollers[1], 940, rint(6,9));
    const i3=await spinRoller(rollers[2], 1040, rint(6,10));
    const a=symbols[i1], b=symbols[i2], c=symbols[i3];
    out.textContent = (a===b && b===c) ? '–ü–æ–±–µ–¥–∞! üéâ' : '–ü–æ—á—Ç–∏!';
  }
  document.getElementById('spinBtn').onclick=spinOnce;

  makeControls(wrap, spinOnce);
}

/* ---------- BASKETBALL (—Ñ–∏–∑–∏–∫–∞ + –∫–ª–∞–º–ø–∏–Ω–≥) ---------- */
function mountBasket(){
  gameArea.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  const stage=document.createElement('div'); stage.className='stage';
  const hoop=document.createElement('div'); hoop.className='hoop'; hoop.textContent='üüß';
  const ball=document.createElement('div'); ball.className='ball'; ball.textContent='üèÄ';
  stage.append(hoop,ball); card.appendChild(stage); gameArea.appendChild(card);

  const sprite=makeSprite(ball, stage);

  function runOnce(){
    return new Promise(resolve=>{
      const S = sprite.get(); // —Ä–∞–∑–º–µ—Ä—ã –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
      const startX=12, startY=S.H-64; sprite.set(startX,startY);

      // —Ü–µ–ª—å ‚Äî —Ä–∞–π–æ–Ω –∫–æ–ª—å—Ü–∞ —Å –Ω–µ–±–æ–ª—å—à–∏–º —à—É–º–æ–º (–∏–Ω–æ–≥–¥–∞ –ø—Ä–æ–º–∞—Ö)
      const goalX = S.W-58 + rand(-6,6);
      const goalY = 68 + rand(-10,10);
      const miss = Math.random() < 0.42;
      const targetX = miss ? goalX + rand(-40,40) : goalX;
      const targetY = miss ? goalY + rand(10,40)  : goalY;

      // –±–∞–ª–ª–∏—Å—Ç–∏–∫–∞: –ø–æ–¥–±–∏—Ä–∞–µ–º –≤—Ä–µ–º—è –ø–æ–ª—ë—Ç–∞ T –∏ –Ω–∞—á–∞–ª—å–Ω—ã–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
      const g=1600; // px/s^2 (–≤–Ω–∏–∑)
      const T=rand(0.75,1.15);
      let vx=(targetX-startX)/T;
      let vy=(targetY-startY - 0.5*g*T*T)/T;

      // ¬´–º–∏—Ä¬ª: –æ—Ç—Å–∫–æ–∫–∏ –æ—Ç –ø–æ–ª–∞/—Å—Ç–µ–Ω
      let tPrev=performance.now();
      let bounced=0;
      const maxTime=3200; const t0=tPrev;

      function loop(now){
        const dt=Math.min(32, now - tPrev)/1000; tPrev=now;

        // –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ–º
        vy += g*dt;
        let nx = sprite.get().x + vx*dt;
        let ny = sprite.get().y + vy*dt;

        // –∫–ª–∞–º–ø–∏–Ω–≥ + –æ—Ç—Å–∫–æ–∫–∏
        const {w,h,W,H} = sprite.get();
        if(nx <= 0){ nx=0; vx = Math.abs(vx)*0.85; bounced++; }
        if(nx >= W - w){ nx=W-w; vx = -Math.abs(vx)*0.85; bounced++; }
        if(ny >= H - h){ ny=H-h; vy = -Math.abs(vy)*0.62; vx *= 0.96; bounced++; }
        if(ny <= 0){ ny=0; vy = Math.abs(vy)*0.62; bounced++; }

        sprite.set(nx,ny);

        // —á–µ–∫ ¬´–ø–æ–ø–∞–ª¬ª: –µ—Å–ª–∏ –ø—Ä–æ—à—ë–ª —á–µ—Ä–µ–∑ –æ–±–ª–∞—Å—Ç—å –∫–æ–ª—å—Ü–∞ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑
        const hit = !miss && (Math.abs(nx - (S.W-58))<22) && (ny<goalY+10) && vy>0;
        if(hit){
          ball.textContent='‚ú®';
          setTimeout(()=>resolve(),250);
          return;
        }

        // —É—Å–ª–æ–≤–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        const elapsed=now - t0;
        const speed=Math.hypot(vx,vy);
        if(elapsed>maxTime || (bounced>6 && speed<60)){
          setTimeout(resolve,150);
          return;
        }
        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);
    });
  }

  makeControls(card, runOnce);
  runOnce(); // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
}

/* ---------- BOWLING (–∫–µ–≥–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Å—Ü–µ–Ω–µ) ---------- */
function mountBowling(){
  gameArea.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  const stage=document.createElement('div'); stage.className='stage';
  const ball=document.createElement('div'); ball.className='bowl'; ball.textContent='üé≥';
  stage.appendChild(ball);

  // —Å–µ—Ç–∫–∞ –∫–µ–≥–ª–µ–π 4-3-2-1 (10 —à—Ç)
  const pins=[];
  const baseX=180, baseY=34, gap=28;
  let idx=0;
  for(let row=0; row<4; row++){
    const inRow = 4-row;
    for(let c=0;c<inRow;c++){
      const p=document.createElement('div'); p.className='pin'; p.textContent='üé≥';
      p.style.left=(baseX + c*gap + row*gap*0.5)+'px';
      p.style.top=(baseY + row*gap)+'px';
      stage.appendChild(p); pins.push(p);
      idx++;
    }
  }
  card.appendChild(stage); gameArea.appendChild(card);

  const sBall=makeSprite(ball, stage);
  const physPins = pins.map(p=>({el:p, spr:makeSprite(p,stage), vx:0, vy:0, active:false}));

  function runOnce(){
    return new Promise(resolve=>{
      // —Å—Ç–∞—Ä—Ç —à–∞—Ä–∞ —Å–ª–µ–≤–∞ –≤–Ω–∏–∑—É
      const H=stage.clientHeight;
      sBall.set(8, H-68);

      let vx = rand(360, 520); // px/s
      let vy = rand(-60, 30);
      const g = 1900;
      let tPrev=performance.now();
      let done=false;
      const started=performance.now();

      const pinBox = {x: 180-10, y: 20, w: 160, h: 130};

      function loop(now){
        if(done) return;
        const dt=Math.min(32, now - tPrev)/1000; tPrev=now;

        // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∞—Ä–∞
        let B=sBall.get();
        vy += g*dt;
        let nx=B.x + vx*dt;
        let ny=B.y + vy*dt;

        // –∫–ª–∞–º–ø–∏–Ω–≥ —à–∞—Ä–∞
        if(nx > B.W - B.w){ nx = B.W - B.w; vx*=-0.6; }
        if(nx < 0){ nx=0; vx*=-0.6; }
        if(ny > B.H - B.h){ ny=B.H-B.h; vy*=-0.45; vx*=0.98; }

        sBall.set(nx,ny);
        B=sBall.get();

        // —Ç—Ä–∏–≥–≥–µ—Ä —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π —Å –∫–µ–≥–ª—è–º–∏
        const ballCenter={x:B.x+B.w*0.5, y:B.y+B.h*0.5};
        const entersPins = (ballCenter.x > pinBox.x && ballCenter.x < pinBox.x+pinBox.w);
        if(entersPins){
          physPins.forEach((pp,i)=>{
            if(!pp.active){
              const P=pp.spr.get();
              const dx=(P.x+P.w*0.5) - ballCenter.x;
              const dy=(P.y+P.h*0.5) - ballCenter.y;
              const dist=Math.hypot(dx,dy);
              if(dist<54){ // ¬´—É–¥–∞—Ä¬ª
                const force = 620 + Math.random()*420;
                const ang = Math.atan2(dy,dx);
                pp.vx = Math.cos(ang)*force;
                pp.vy = Math.sin(ang)*force - 200;
                pp.active=true;
              }
            }
          });
        }

        // —Ñ–∏–∑–∏–∫–∞ –∫–µ–≥–ª–µ–π (–≤—Å–µ–≥–¥–∞ –≤ —Å—Ü–µ–Ω–µ)
        physPins.forEach(pp=>{
          const P=pp.spr.get();
          if(pp.active){
            pp.vy += g*dt;
            let px=P.x + pp.vx*dt;
            let py=P.y + pp.vy*dt;

            if(px<0){ px=0; pp.vx=Math.abs(pp.vx)*0.58; }
            if(px>P.W-P.w){ px=P.W-P.w; pp.vx=-Math.abs(pp.vx)*0.58; }
            if(py>P.H-P.h){ py=P.H-P.h; pp.vy=-Math.abs(pp.vy)*0.45; pp.vx*=0.96; }
            if(py<0){ py=0; pp.vy=Math.abs(pp.vy)*0.45; }

            // –ª—ë–≥–∫–∏–π –ø–æ–≤–æ—Ä–æ—Ç + –∑–∞—Ç—É—Ö–∞–Ω–∏–µ
            pp.el.style.transition='transform .0s';
            pp.spr.set(px,py);
          }
        });

        // –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ: —à–∞—Ä –¥–æ–∫–∞—Ç–∏–ª—Å—è, –∫–µ–≥–ª–∏ —É—Ç–∏—Ö–ª–∏
        const speed = Math.hypot(vx,vy);
        const activePins = physPins.filter(p=>p.active && (Math.hypot(p.vx,p.vy)>60)).length;
        if((now-started)>3500 && speed<80 && activePins===0){
          done=true; setTimeout(resolve,120);
          return;
        }
        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);
    });
  }

  makeControls(card, runOnce);
  runOnce();
}

/* ---------- DARTS (–≤ —Ü–µ–Ω—Ç—Ä –º–∏—à–µ–Ω–∏, –±–µ–∑ –≤—ã—Ö–æ–¥–∞) ---------- */
function mountDarts(){
  gameArea.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  const stage=document.createElement('div'); stage.className='stage';
  const target=document.createElement('div'); target.className='target';
  const dart=document.createElement('div'); dart.className='dart'; dart.textContent='ü™Å'; dart.style.fontSize='38px';
  stage.append(target,dart); card.appendChild(stage); gameArea.appendChild(card);

  const spr=makeSprite(dart,stage);

  function runOnce(){
    return new Promise(resolve=>{
      const S=spr.get();
      const cx=S.W/2-10, cy=S.H/2-10;
      spr.set(-42, 26);

      const bull = Math.random()<0.5;
      const endX = bull? cx : cx + rand(-40,40);
      const endY = bull? cy : cy + rand(-24,24);

      const dur = rand(650, 950);
      const t0=performance.now();

      function loop(now){
        const p=clamp((now-t0)/dur,0,1);
        const wobble = (1-p)*Math.sin(p*10)* (bull? 8 : 16);
        const x = -42 + p*(endX+42);
        const y = 26 + (endY-26)*p + (bull? 0 : wobble);
        spr.set(x,y);
        dart.style.transform += ` rotate(18deg)`;
        if(p<1) requestAnimationFrame(loop);
        else { dart.textContent = 'üéØ'; setTimeout(resolve,160); }
      }
      requestAnimationFrame(loop);
    });
  }

  makeControls(card, runOnce);
  runOnce();
}

/* ---------- –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –ò–ì–† ---------- */
function showGame(kind){
  if(kind==='slot') mountSlot();
  if(kind==='basket') mountBasket();
  if(kind==='bowling') mountBowling();
  if(kind==='darts') mountDarts();
}
document.querySelectorAll('[data-game]').forEach(b=>b.onclick=()=>showGame(b.dataset.game));
showGame('slot'); // default

/* -----------------------------------------------------------
   –ü—Ä–æ—á–µ–µ
----------------------------------------------------------- */
document.getElementById('copyRef').onclick=async()=>{
  try{
    await navigator.clipboard.writeText(document.getElementById('refLink').value);
    toast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
  }catch{ toast('–°–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é'); }
};
document.getElementById('closeBtn').onclick=()=>tg?.close?.();

tg?.ready?.(); tg?.expand?.(); applyTheme();

/* SHOP proceed (–∫–∞–∫ –±—ã–ª–æ) */
document.getElementById('proceed').onclick=()=>{
  const u=(document.getElementById('username').value.trim()||'@username');
  const qty=document.getElementById('amount').parentElement.style.display==='none' ? '' : ` ‚Ä¢ ${document.getElementById('amount').value||checkoutState.qty||0} ‚≠ê`;
  toast(`–ó–∞—è–≤–∫–∞: ${checkoutState.label} ‚Üí ${u}${qty}`);
};
</script>
</body>
</html>
